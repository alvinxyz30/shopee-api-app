{% extends "base.html" %}

{% block title %}Data Return - {{ shop.shop_name }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1>
                    <i class="fas fa-undo"></i> Data Return
                </h1>
                <p class="text-muted mb-0">{{ shop.shop_name }} ({{ total_returns }} return ditemukan)</p>
            </div>
            <div>
                <a href="{{ url_for('shop_detail', shop_id=shop.shop_id) }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Kembali
                </a>
                <button class="btn btn-success" onclick="exportReturns()">
                    <i class="fas fa-file-excel"></i> Export Excel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Date Filter -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <form method="GET" id="dateFilterForm">
                    <div class="row align-items-end">
                        <div class="col-md-3">
                            <label for="date_from" class="form-label">Tanggal Mulai</label>
                            <input type="date" class="form-control" id="date_from" name="date_from" 
                                   value="{{ date_from }}">
                        </div>
                        <div class="col-md-3">
                            <label for="date_to" class="form-label">Tanggal Akhir</label>
                            <input type="date" class="form-control" id="date_to" name="date_to" 
                                   value="{{ date_to }}">
                        </div>
                        <div class="col-md-3">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search"></i> Filter
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="resetDateFilter()">
                                <i class="fas fa-undo"></i> Reset
                            </button>
                        </div>
                        <div class="col-md-3 text-end">
                            <small class="text-muted">
                                <i class="fas fa-info-circle"></i> Menampilkan {{ returns|length }} dari {{ total_returns }} return
                            </small>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% if returns %}
<!-- Returns Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-list"></i> Daftar Return
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover data-table">
                        <thead class="table-dark">
                            <tr>
                                <th>Return SN</th>
                                <th>Order SN</th>
                                <th>Status</th>
                                <th>Tanggal Return</th>
                                <th>Buyer</th>
                                <th>Item</th>
                                <th>Alasan</th>
                                <th>Return Amount</th>
                                <th>Tracking No</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for return in returns %}
                            <tr>
                                <td>
                                    <code>{{ return.return_sn }}</code>
                                </td>
                                <td>
                                    <code>{{ return.order_sn }}</code>
                                </td>
                                <td>
                                    {% set status_class = {
                                        'PROCESSING': 'warning',
                                        'COMPLETED': 'success',
                                        'CANCELLED': 'danger',
                                        'SELLER_PROCESSING': 'info',
                                        'BUYER_PROCESSING': 'primary'
                                    } %}
                                    <span class="badge bg-{{ status_class.get(return.status, 'secondary') }}">
                                        {{ return.status }}
                                    </span>
                                </td>
                                <td>
                                    {{ return.create_time|timestamp_to_date if return.create_time else '-' }}
                                </td>
                                <td>
                                    {% if return.user %}
                                        {{ return.user.username if return.user.username else '-' }}
                                        <br><small class="text-muted">ID: {{ return.user.user_id if return.user.user_id else '-' }}</small>
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                    {% if return.item %}
                                        {{ return.item.item_name[:25] if return.item.item_name else '-' }}
                                        {% if return.item.item_name and return.item.item_name|length > 25 %}...{% endif %}
                                        {% if return.item.model_name %}
                                            <br><small class="text-muted">{{ return.item.model_name }}</small>
                                        {% endif %}
                                        {% if return.item.amount %}
                                            <br><small class="text-muted">Qty: {{ return.item.amount }}</small>
                                        {% endif %}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                    {% if return.reason %}
                                        <span class="badge bg-warning">{{ return.reason }}</span>
                                    {% endif %}
                                    {% if return.text_reason %}
                                        <br><small class="text-muted">{{ return.text_reason[:30] }}{% if return.text_reason|length > 30 %}...{% endif %}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <strong>{{ "Rp {:,.0f}".format(return.return_amount) if return.return_amount else '-' }}</strong>
                                </td>
                                <td>
                                    {% if return.return_shipping and return.return_shipping.tracking_number %}
                                        <code>{{ return.return_shipping.tracking_number }}</code>
                                        {% if return.return_shipping.shipping_carrier %}
                                            <br><small class="text-muted">{{ return.return_shipping.shipping_carrier }}</small>
                                        {% endif %}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                    <button class="btn btn-outline-primary btn-sm" 
                                            onclick="showReturnDetail('{{ return.return_sn }}')">
                                        <i class="fas fa-eye"></i> Detail
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Pagination -->
{% if total_pages > 1 %}
<div class="row pagination-container">
    <div class="col-12">
        <nav aria-label="Returns pagination">
            <ul class="pagination justify-content-center">
                {% if page > 1 %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page - 1 }}&date_from={{ date_from }}&date_to={{ date_to }}">
                            <i class="fas fa-chevron-left"></i> Previous
                        </a>
                    </li>
                {% endif %}
                
                {% for p in range(1, total_pages + 1) %}
                    {% if p == page %}
                        <li class="page-item active">
                            <span class="page-link">{{ p }}</span>
                        </li>
                    {% elif p <= 3 or p >= total_pages - 2 or (p >= page - 1 and p <= page + 1) %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ p }}&date_from={{ date_from }}&date_to={{ date_to }}">{{ p }}</a>
                        </li>
                    {% elif p == 4 and page > 6 %}
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                    {% elif p == total_pages - 3 and page < total_pages - 5 %}
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                    {% endif %}
                {% endfor %}
                
                {% if page < total_pages %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page + 1 }}&date_from={{ date_from }}&date_to={{ date_to }}">
                            Next <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                {% endif %}
            </ul>
        </nav>
    </div>
</div>
{% endif %}

{% else %}
<!-- Empty State -->
<div class="row">
    <div class="col-12">
        <div class="text-center py-5">
            <i class="fas fa-undo fa-5x text-muted mb-4"></i>
            <h3 class="text-muted">Tidak Ada Data Return</h3>
            <p class="text-muted mb-4">
                {% if date_from and date_to %}
                    Tidak ada return ditemukan untuk periode {{ date_from }} - {{ date_to }}.
                {% else %}
                    Tidak ada return ditemukan di toko ini.
                {% endif %}
            </p>
            <button class="btn btn-primary" onclick="resetDateFilter()">
                <i class="fas fa-calendar-alt"></i> Ubah Range Tanggal
            </button>
        </div>
    </div>
</div>
{% endif %}

<!-- Return Detail Modal -->
<div class="modal fade" id="returnDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detail Return</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="returnDetailContent">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
function exportReturns() {
    var dateFrom = document.getElementById('date_from').value;
    var dateTo = document.getElementById('date_to').value;
    
    if (confirmExport('returns', '{{ shop.shop_name }}')) {
        var url = `/export/{{ shop.shop_id }}/returns?date_from=${dateFrom}&date_to=${dateTo}`;
        window.location.href = url;
    }
}

function resetDateFilter() {
    var today = new Date();
    var ninetyDaysAgo = new Date(today.getTime() - (90 * 24 * 60 * 60 * 1000));
    
    document.getElementById('date_to').value = today.toISOString().split('T')[0];
    document.getElementById('date_from').value = ninetyDaysAgo.toISOString().split('T')[0];
    
    document.getElementById('dateFilterForm').submit();
}

function showReturnDetail(returnSn) {
    var modal = new bootstrap.Modal(document.getElementById('returnDetailModal'));
    modal.show();
    
    // Find return data from current page
    var returnData = null;
    {% for return in returns %}
        if ('{{ return.return_sn }}' === returnSn) {
            returnData = {{ return|tojson }};
        }
    {% endfor %}
    
    if (returnData) {
        displayReturnDetail(returnData);
    } else {
        document.getElementById('returnDetailContent').innerHTML = 
            '<div class="alert alert-danger">Return detail tidak ditemukan</div>';
    }
}

function displayReturnDetail(returnData) {
    var content = `
        <div class="row">
            <div class="col-md-6">
                <h6>Informasi Return</h6>
                <table class="table table-sm">
                    <tr><td><strong>Return SN:</strong></td><td>${returnData.return_sn}</td></tr>
                    <tr><td><strong>Order SN:</strong></td><td>${returnData.order_sn}</td></tr>
                    <tr><td><strong>Status:</strong></td><td><span class="badge bg-primary">${returnData.status}</span></td></tr>
                    <tr><td><strong>Tanggal Return:</strong></td><td>${formatTimestamp(returnData.create_time)}</td></tr>
                    <tr><td><strong>Update Terakhir:</strong></td><td>${formatTimestamp(returnData.update_time)}</td></tr>
                    <tr><td><strong>Due Date:</strong></td><td>${formatTimestamp(returnData.due_date)}</td></tr>
                    <tr><td><strong>Return Amount:</strong></td><td><strong>Rp ${(returnData.return_amount || 0).toLocaleString()}</strong></td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6>Informasi Buyer</h6>
                <table class="table table-sm">
    `;
    
    if (returnData.user) {
        content += `
            <tr><td><strong>Username:</strong></td><td>${returnData.user.username || '-'}</td></tr>
            <tr><td><strong>User ID:</strong></td><td>${returnData.user.user_id || '-'}</td></tr>
        `;
    } else {
        content += '<tr><td colspan="2">Informasi buyer tidak tersedia</td></tr>';
    }
    
    content += `
                </table>
                
                <h6>Return Shipping</h6>
                <table class="table table-sm">
    `;
    
    if (returnData.return_shipping) {
        content += `
            <tr><td><strong>Tracking Number:</strong></td><td>${returnData.return_shipping.tracking_number || '-'}</td></tr>
            <tr><td><strong>Shipping Carrier:</strong></td><td>${returnData.return_shipping.shipping_carrier || '-'}</td></tr>
        `;
    } else {
        content += '<tr><td colspan="2">Informasi shipping tidak tersedia</td></tr>';
    }
    
    content += `
                </table>
            </div>
        </div>
        
        <div class="row mt-3">
            <div class="col-12">
                <h6>Alasan Return</h6>
                <table class="table table-sm">
                    <tr><td><strong>Reason Code:</strong></td><td>${returnData.reason || '-'}</td></tr>
                    <tr><td><strong>Text Reason:</strong></td><td>${returnData.text_reason || '-'}</td></tr>
                    <tr><td><strong>Dispute Reason:</strong></td><td>${returnData.dispute_reason || '-'}</td></tr>
                </table>
            </div>
        </div>
    `;
    
    if (returnData.item) {
        content += `
            <div class="row mt-3">
                <div class="col-12">
                    <h6>Item Information</h6>
                    <table class="table table-sm">
                        <tr><td><strong>Item Name:</strong></td><td>${returnData.item.item_name || '-'}</td></tr>
                        <tr><td><strong>Item SKU:</strong></td><td>${returnData.item.item_sku || '-'}</td></tr>
                        <tr><td><strong>Model Name:</strong></td><td>${returnData.item.model_name || '-'}</td></tr>
                        <tr><td><strong>Model SKU:</strong></td><td>${returnData.item.model_sku || '-'}</td></tr>
                        <tr><td><strong>Return Quantity:</strong></td><td>${returnData.item.amount || 0}</td></tr>
                    </table>
                </div>
            </div>
        `;
    }
    
    if (returnData.image && returnData.image.length > 0) {
        content += `
            <div class="row mt-3">
                <div class="col-12">
                    <h6>Bukti Return (${returnData.image.length} gambar)</h6>
                    <div class="row">
        `;
        
        returnData.image.slice(0, 4).forEach((imageUrl, index) => {
            content += `
                <div class="col-3 mb-2">
                    <img src="${imageUrl}" class="img-fluid rounded" alt="Return Proof ${index + 1}">
                </div>
            `;
        });
        
        content += '</div>';
        
        if (returnData.image.length > 4) {
            content += `<small class="text-muted">+${returnData.image.length - 4} gambar lainnya</small>`;
        }
        
        content += '</div></div>';
    }
    
    document.getElementById('returnDetailContent').innerHTML = content;
}

function formatTimestamp(timestamp) {
    if (!timestamp) return '-';
    return new Date(timestamp * 1000).toLocaleString('id-ID');
}
</script>
{% endblock %}