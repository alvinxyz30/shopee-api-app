{% extends "base.html" %}

{% block title %}Data Order - {{ shop.shop_name }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1>
                    <i class="fas fa-shopping-cart"></i> Data Order
                </h1>
                <p class="text-muted mb-0">{{ shop.shop_name }} ({{ total_orders }} order ditemukan)</p>
            </div>
            <div>
                <a href="{{ url_for('shop_detail', shop_id=shop.shop_id) }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Kembali
                </a>
                <button class="btn btn-success" onclick="exportOrders()">
                    <i class="fas fa-file-excel"></i> Export Excel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Date Filter -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <form method="GET" id="dateFilterForm">
                    <div class="row align-items-end">
                        <div class="col-md-3">
                            <label for="date_from" class="form-label">Tanggal Mulai</label>
                            <input type="date" class="form-control" id="date_from" name="date_from" 
                                   value="{{ date_from }}">
                        </div>
                        <div class="col-md-3">
                            <label for="date_to" class="form-label">Tanggal Akhir</label>
                            <input type="date" class="form-control" id="date_to" name="date_to" 
                                   value="{{ date_to }}">
                        </div>
                        <div class="col-md-3">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search"></i> Filter
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="resetDateFilter()">
                                <i class="fas fa-undo"></i> Reset
                            </button>
                        </div>
                        <div class="col-md-3 text-end">
                            <small class="text-muted">
                                <i class="fas fa-info-circle"></i> Menampilkan {{ orders|length }} dari {{ total_orders }} order
                            </small>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% if orders %}
<!-- Orders Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-list"></i> Daftar Order
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover data-table">
                        <thead class="table-dark">
                            <tr>
                                <th>Order SN</th>
                                <th>Status</th>
                                <th>Tanggal Order</th>
                                <th>Buyer</th>
                                <th>Total Amount</th>
                                <th>Payment Method</th>
                                <th>Item</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for order in orders %}
                            <tr>
                                <td>
                                    <code>{{ order.order_sn }}</code>
                                </td>
                                <td>
                                    {% set status_class = {
                                        'UNPAID': 'danger',
                                        'TO_SHIP': 'warning',
                                        'READY_TO_SHIP': 'warning',
                                        'SHIPPED': 'info',
                                        'TO_CONFIRM_RECEIVE': 'primary',
                                        'COMPLETED': 'success',
                                        'CANCELLED': 'secondary',
                                        'TO_RETURN': 'danger'
                                    } %}
                                    <span class="badge bg-{{ status_class.get(order.order_status, 'secondary') }}">
                                        {{ order.order_status }}
                                    </span>
                                </td>
                                <td>
                                    {{ order.create_time|timestamp_to_date if order.create_time else '-' }}
                                </td>
                                <td>
                                    {{ order.buyer_username if order.buyer_username else '-' }}
                                </td>
                                <td>
                                    <strong>{{ "Rp {:,.0f}".format(order.total_amount) if order.total_amount else '-' }}</strong>
                                </td>
                                <td>
                                    {{ order.payment_method if order.payment_method else '-' }}
                                </td>
                                <td>
                                    {% if order.item_list %}
                                        {% set first_item = order.item_list[0] %}
                                        {{ first_item.item_name[:30] }}{% if first_item.item_name|length > 30 %}...{% endif %}
                                        {% if order.item_list|length > 1 %}
                                            <br><small class="text-muted">(+{{ order.item_list|length - 1 }} item lainnya)</small>
                                        {% endif %}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                    <button class="btn btn-outline-primary btn-sm" 
                                            onclick="showOrderDetail('{{ order.order_sn }}')">
                                        <i class="fas fa-eye"></i> Detail
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Pagination -->
{% if total_pages > 1 %}
<div class="row pagination-container">
    <div class="col-12">
        <nav aria-label="Orders pagination">
            <ul class="pagination justify-content-center">
                {% if page > 1 %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page - 1 }}&date_from={{ date_from }}&date_to={{ date_to }}">
                            <i class="fas fa-chevron-left"></i> Previous
                        </a>
                    </li>
                {% endif %}
                
                {% for p in range(1, total_pages + 1) %}
                    {% if p == page %}
                        <li class="page-item active">
                            <span class="page-link">{{ p }}</span>
                        </li>
                    {% elif p <= 3 or p >= total_pages - 2 or (p >= page - 1 and p <= page + 1) %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ p }}&date_from={{ date_from }}&date_to={{ date_to }}">{{ p }}</a>
                        </li>
                    {% elif p == 4 and page > 6 %}
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                    {% elif p == total_pages - 3 and page < total_pages - 5 %}
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                    {% endif %}
                {% endfor %}
                
                {% if page < total_pages %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page + 1 }}&date_from={{ date_from }}&date_to={{ date_to }}">
                            Next <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                {% endif %}
            </ul>
        </nav>
    </div>
</div>
{% endif %}

{% else %}
<!-- Empty State -->
<div class="row">
    <div class="col-12">
        <div class="text-center py-5">
            <i class="fas fa-shopping-cart fa-5x text-muted mb-4"></i>
            <h3 class="text-muted">Tidak Ada Data Order</h3>
            <p class="text-muted mb-4">Tidak ada order ditemukan untuk periode {{ date_from }} - {{ date_to }}.</p>
            <button class="btn btn-primary" onclick="resetDateFilter()">
                <i class="fas fa-calendar-alt"></i> Ubah Range Tanggal
            </button>
        </div>
    </div>
</div>
{% endif %}

<!-- Order Detail Modal -->
<div class="modal fade" id="orderDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detail Order</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="orderDetailContent">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
function exportOrders() {
    var dateFrom = document.getElementById('date_from').value;
    var dateTo = document.getElementById('date_to').value;
    
    if (confirmExport('orders', '{{ shop.shop_name }}')) {
        var url = `/export/{{ shop.shop_id }}/orders?date_from=${dateFrom}&date_to=${dateTo}`;
        window.location.href = url;
    }
}

function resetDateFilter() {
    var today = new Date();
    var sevenDaysAgo = new Date(today.getTime() - (7 * 24 * 60 * 60 * 1000));
    
    document.getElementById('date_to').value = today.toISOString().split('T')[0];
    document.getElementById('date_from').value = sevenDaysAgo.toISOString().split('T')[0];
    
    document.getElementById('dateFilterForm').submit();
}

function showOrderDetail(orderSn) {
    var modal = new bootstrap.Modal(document.getElementById('orderDetailModal'));
    modal.show();
    
    // Find order data from current page
    var orderData = null;
    {% for order in orders %}
        if ('{{ order.order_sn }}' === orderSn) {
            orderData = {{ order|tojson }};
        }
    {% endfor %}
    
    if (orderData) {
        displayOrderDetail(orderData);
    } else {
        document.getElementById('orderDetailContent').innerHTML = 
            '<div class="alert alert-danger">Order detail tidak ditemukan</div>';
    }
}

function displayOrderDetail(order) {
    var content = `
        <div class="row">
            <div class="col-md-6">
                <h6>Informasi Order</h6>
                <table class="table table-sm">
                    <tr><td><strong>Order SN:</strong></td><td>${order.order_sn}</td></tr>
                    <tr><td><strong>Status:</strong></td><td><span class="badge bg-primary">${order.order_status}</span></td></tr>
                    <tr><td><strong>Tanggal Order:</strong></td><td>${formatTimestamp(order.create_time)}</td></tr>
                    <tr><td><strong>Total Amount:</strong></td><td><strong>Rp ${(order.total_amount || 0).toLocaleString()}</strong></td></tr>
                    <tr><td><strong>Shipping Fee:</strong></td><td>Rp ${(order.actual_shipping_fee || 0).toLocaleString()}</td></tr>
                    <tr><td><strong>Payment Method:</strong></td><td>${order.payment_method || '-'}</td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6>Informasi Buyer</h6>
                <table class="table table-sm">
                    <tr><td><strong>Username:</strong></td><td>${order.buyer_username || '-'}</td></tr>
                    <tr><td><strong>User ID:</strong></td><td>${order.buyer_user_id || '-'}</td></tr>
                </table>
                
                <h6>Shipping Info</h6>
                <table class="table table-sm">
                    <tr><td><strong>Carrier:</strong></td><td>${order.shipping_carrier || '-'}</td></tr>
                    <tr><td><strong>Tracking No:</strong></td><td>${order.tracking_no || '-'}</td></tr>
                </table>
            </div>
        </div>
    `;
    
    if (order.item_list && order.item_list.length > 0) {
        content += `
            <div class="row mt-3">
                <div class="col-12">
                    <h6>Items (${order.item_list.length})</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th>Item Name</th>
                                    <th>SKU</th>
                                    <th>Model</th>
                                    <th>Qty</th>
                                    <th>Price</th>
                                </tr>
                            </thead>
                            <tbody>
        `;
        
        order.item_list.forEach(item => {
            content += `
                <tr>
                    <td>${item.item_name || '-'}</td>
                    <td>${item.item_sku || '-'}</td>
                    <td>${item.model_name || '-'}</td>
                    <td>${item.model_quantity || 0}</td>
                    <td>Rp ${(item.model_original_price || 0).toLocaleString()}</td>
                </tr>
            `;
        });
        
        content += `
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
    }
    
    document.getElementById('orderDetailContent').innerHTML = content;
}

function formatTimestamp(timestamp) {
    if (!timestamp) return '-';
    return new Date(timestamp * 1000).toLocaleString('id-ID');
}

// Add template filter for timestamp conversion
{% set timestamp_to_date = 'function' %}
</script>
{% endblock %}