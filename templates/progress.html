<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Progress Export - Shopee API</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .progress-container {
            max-width: 600px;
            margin: 50px auto;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        .progress {
            height: 30px;
            margin: 20px 0;
            border-radius: 15px;
        }
        .progress-bar {
            transition: width 0.5s ease-in-out;
            border-radius: 15px;
            font-weight: bold;
        }
        .status-text {
            font-size: 18px;
            margin: 15px 0;
        }
        .spinner-border {
            margin-right: 10px;
        }
        .completed-icon {
            color: #28a745;
            font-size: 24px;
            margin-right: 10px;
        }
        .error-icon {
            color: #dc3545;
            font-size: 24px;
            margin-right: 10px;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container">
        <div class="progress-container bg-white">
            <div class="text-center mb-4">
                <h2>üöÄ Export Data Progress</h2>
                <p class="text-muted">Toko ID: {{ export_data.shop_id }} | Tipe: {{ export_data.data_type.title() }}</p>
            </div>

            <!-- Progress Bar -->
            <div class="progress">
                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                     role="progressbar" 
                     style="width: 0%"
                     id="progressBar">
                    0%
                </div>
            </div>

            <!-- Status Text -->
            <div class="status-text text-center" id="statusText">
                {% if export_data.status == 'initializing' %}
                    <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                    {{ export_data.current_step }}
                {% elif export_data.status == 'processing' %}
                    <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                    {{ export_data.current_step }}
                {% elif export_data.status == 'completed' %}
                    <span class="completed-icon">‚úÖ</span>
                    {{ export_data.current_step }}
                {% elif export_data.status == 'error' %}
                    <span class="error-icon">‚ùå</span>
                    Error: {{ export_data.error }}
                {% endif %}
            </div>

            <!-- Action Buttons -->
            <div class="text-center mt-4">
                {% if export_data.status == 'initializing' %}
                    <button id="startBtn" class="btn btn-primary btn-lg" onclick="startExport()">
                        üöÄ Mulai Export
                    </button>
                {% elif export_data.status == 'processing' %}
                    <button class="btn btn-secondary btn-lg" disabled>
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                        Sedang Memproses...
                    </button>
                {% elif export_data.status == 'completed' %}
                    {% if export_data.data %}
                        <a href="{{ url_for('download_export') }}" class="btn btn-success btn-lg">
                            üì• Download Excel ({{ export_data.data|length }} records)
                        </a>
                    {% else %}
                        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary btn-lg">
                            üè† Kembali ke Dashboard
                        </a>
                    {% endif %}
                {% elif export_data.status == 'error' %}
                    <a href="{{ url_for('dashboard') }}" class="btn btn-danger btn-lg">
                        üè† Kembali ke Dashboard
                    </a>
                {% endif %}

                <br><br>
                <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
                    ‚Üê Kembali ke Dashboard
                </a>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let isProcessing = false;
        
        function startExport() {
            console.log('=== START EXPORT FUNCTION CALLED ===');
            
            if (isProcessing) {
                console.log('Already processing, returning early');
                return;
            }
            
            isProcessing = true;
            console.log('Setting isProcessing to true');
            
            const startBtn = document.getElementById('startBtn');
            if (startBtn) {
                startBtn.disabled = true;
                startBtn.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Memulai...';
                console.log('Start button disabled and text updated');
            }
            
            // Update UI to show processing started
            document.getElementById('progressBar').style.width = '1%';
            document.getElementById('progressBar').textContent = '1%';
            document.getElementById('statusText').innerHTML = '<div class="spinner-border spinner-border-sm text-primary" role="status"></div> Memulai export...';
            console.log('UI updated to show 1% progress');
            
            // Start the background export process
            console.log('About to call /start_chunked_export');
            fetch('/start_chunked_export', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({})
            })
            .then(response => {
                console.log('Fetch response received:', response);
                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);
                
                if (!response.ok) {
                    console.error('Response not ok, status:', response.status);
                    throw new Error(`Network response was not ok: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Export started successfully:', data);
                if (data.error) {
                    console.error('Server returned error:', data.error);
                    alert('Error: ' + data.error);
                    location.reload();
                } else {
                    console.log('Starting progress polling...');
                    // Start polling for progress updates immediately
                    startProgressPolling();
                }
            })
            .catch(error => {
                console.error('Error starting export:', error);
                console.error('Full error object:', error);
                alert('Terjadi kesalahan saat memulai export: ' + error.message);
                location.reload();
            });
        }
        
        function startProgressPolling() {
            console.log('=== STARTING PROGRESS POLLING ===');
            const pollInterval = setInterval(() => {
                console.log('Polling for progress...');
                fetch('/api/progress_status')
                .then(response => {
                    console.log('Progress response:', response);
                    return response.json();
                })
                .then(data => {
                    console.log('Progress update received:', data);
                    
                    if (data.error) {
                        console.error('Progress error:', data.error);
                        clearInterval(pollInterval);
                        return;
                    }
                    
                    // Update progress bar
                    const progressBar = document.getElementById('progressBar');
                    const statusText = document.getElementById('statusText');
                    
                    console.log('Updating progress bar to:', data.progress + '%');
                    progressBar.style.width = data.progress + '%';
                    progressBar.textContent = data.progress + '%';
                    
                    // Update status text based on status
                    let statusHTML = '';
                    if (data.status === 'processing') {
                        statusHTML = '<div class="spinner-border spinner-border-sm text-primary" role="status"></div> ' + data.current_step;
                        console.log('Status: processing -', data.current_step);
                    } else if (data.status === 'completed') {
                        statusHTML = '<span class="completed-icon">‚úÖ</span> ' + data.current_step;
                        console.log('Status: completed -', data.current_step);
                    } else if (data.status === 'error') {
                        statusHTML = '<span class="error-icon">‚ùå</span> Error: ' + data.error;
                        console.log('Status: error -', data.error);
                    } else {
                        statusHTML = data.current_step;
                        console.log('Status: unknown -', data.status, data.current_step);
                    }
                    
                    statusText.innerHTML = statusHTML;
                    
                    // Stop polling if completed or error
                    if (data.status === 'completed' || data.status === 'error') {
                        console.log('Process finished, clearing interval');
                        clearInterval(pollInterval);
                        isProcessing = false;
                        
                        // Update UI to final state
                        if (data.status === 'completed') {
                            setTimeout(() => location.reload(), 2000);
                        }
                    }
                })
                .catch(error => {
                    console.error('Polling error:', error);
                    // Don't clear interval on network errors, keep trying
                });
            }, 1000); // Poll every 1 second (faster)
        }
        
        // Auto-start if status is processing (page refresh case)
        {% if export_data.status == 'processing' %}
            startProgressPolling();
        {% endif %}
    </script>
</body>
</html>