<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Progress Export - Shopee API</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .progress-container {
            max-width: 600px;
            margin: 50px auto;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        .progress {
            height: 30px;
            margin: 20px 0;
            border-radius: 15px;
        }
        .progress-bar {
            transition: width 0.5s ease-in-out;
            border-radius: 15px;
            font-weight: bold;
        }
        .status-text {
            font-size: 18px;
            margin: 15px 0;
        }
        .spinner-border {
            margin-right: 10px;
        }
        .completed-icon {
            color: #28a745;
            font-size: 24px;
            margin-right: 10px;
        }
        .error-icon {
            color: #dc3545;
            font-size: 24px;
            margin-right: 10px;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container">
        <div class="progress-container bg-white">
            <div class="text-center mb-4">
                <h2>üöÄ Export Data Progress</h2>
                <p class="text-muted">Toko ID: {{ export_data.shop_id }} | Tipe: {{ export_data.data_type.title() }}</p>
            </div>

            <!-- Progress Bar -->
            <div class="progress">
                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                     role="progressbar" 
                     style="width: {{ export_data.progress }}%"
                     id="progressBar">
                    {{ export_data.progress }}%
                </div>
            </div>

            <!-- Status Text -->
            <div class="status-text text-center" id="statusText">
                {% if export_data.status == 'initializing' %}
                    <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                    {{ export_data.current_step }}
                {% elif export_data.status == 'processing' %}
                    <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                    {{ export_data.current_step }}
                {% elif export_data.status == 'completed' %}
                    <span class="completed-icon">‚úÖ</span>
                    {{ export_data.current_step }}
                {% elif export_data.status == 'error' %}
                    <span class="error-icon">‚ùå</span>
                    Error: {{ export_data.error }}
                {% endif %}
            </div>

            <!-- Action Buttons -->
            <div class="text-center mt-4">
                {% if export_data.status == 'initializing' %}
                    <button id="startBtn" class="btn btn-primary btn-lg" onclick="startExport()">
                        üöÄ Mulai Export
                    </button>
                {% elif export_data.status == 'processing' %}
                    <button class="btn btn-secondary btn-lg" disabled>
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                        Sedang Memproses...
                    </button>
                {% elif export_data.status == 'completed' %}
                    {% if export_data.data %}
                        <a href="{{ url_for('download_export') }}" class="btn btn-success btn-lg">
                            üì• Download Excel ({{ export_data.data|length }} records)
                        </a>
                    {% else %}
                        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary btn-lg">
                            üè† Kembali ke Dashboard
                        </a>
                    {% endif %}
                {% elif export_data.status == 'error' %}
                    <a href="{{ url_for('dashboard') }}" class="btn btn-danger btn-lg">
                        üè† Kembali ke Dashboard
                    </a>
                {% endif %}

                <br><br>
                <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
                    ‚Üê Kembali ke Dashboard
                </a>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let isProcessing = false;
        
        function startExport() {
            if (isProcessing) return;
            
            isProcessing = true;
            document.getElementById('startBtn').disabled = true;
            document.getElementById('startBtn').innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Memulai...';
            
            fetch('/start_chunked_export', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                    location.reload();
                } else {
                    // Start polling for progress updates
                    startProgressPolling();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Terjadi kesalahan saat memulai export');
                location.reload();
            });
        }
        
        function startProgressPolling() {
            const pollInterval = setInterval(() => {
                fetch('/export_progress')
                .then(response => response.text())
                .then(html => {
                    // Parse the response to get updated progress data
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const newProgressBar = doc.getElementById('progressBar');
                    const newStatusText = doc.getElementById('statusText');
                    
                    if (newProgressBar && newStatusText) {
                        document.getElementById('progressBar').style.width = newProgressBar.style.width;
                        document.getElementById('progressBar').textContent = newProgressBar.textContent;
                        document.getElementById('statusText').innerHTML = newStatusText.innerHTML;
                        
                        // Check if completed
                        if (newProgressBar.textContent.includes('100%') || 
                            newStatusText.innerHTML.includes('‚úÖ') ||
                            newStatusText.innerHTML.includes('‚ùå')) {
                            clearInterval(pollInterval);
                            setTimeout(() => location.reload(), 2000);
                        }
                    }
                })
                .catch(error => {
                    console.error('Polling error:', error);
                    clearInterval(pollInterval);
                });
            }, 2000); // Poll every 2 seconds
        }
        
        // Auto-start if status is processing (page refresh case)
        {% if export_data.status == 'processing' %}
            startProgressPolling();
        {% endif %}
    </script>
</body>
</html>