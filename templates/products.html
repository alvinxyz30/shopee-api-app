{% extends "base.html" %}

{% block title %}Data Produk - {{ shop.shop_name }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1>
                    <i class="fas fa-box"></i> Data Produk
                </h1>
                <p class="text-muted mb-0">{{ shop.shop_name }} ({{ total_products }} produk ditemukan)</p>
            </div>
            <div>
                <a href="{{ url_for('shop_detail', shop_id=shop.shop_id) }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Kembali
                </a>
                <button class="btn btn-success" onclick="exportProducts()">
                    <i class="fas fa-file-excel"></i> Export Excel
                </button>
            </div>
        </div>
    </div>
</div>

{% if products %}
<!-- Products Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-list"></i> Daftar Produk
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover data-table">
                        <thead class="table-dark">
                            <tr>
                                <th>Image</th>
                                <th>Item Name</th>
                                <th>SKU</th>
                                <th>Status</th>
                                <th>Category</th>
                                <th>Price</th>
                                <th>Stock</th>
                                <th>Sales</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for product in products %}
                            <tr>
                                <td>
                                    {% if product.image and product.image.image_url_list %}
                                        <img src="{{ product.image.image_url_list[0] }}" 
                                             alt="Product Image" 
                                             class="img-thumbnail" 
                                             style="width: 50px; height: 50px; object-fit: cover;">
                                    {% else %}
                                        <div class="bg-light d-flex align-items-center justify-content-center" 
                                             style="width: 50px; height: 50px;">
                                            <i class="fas fa-image text-muted"></i>
                                        </div>
                                    {% endif %}
                                </td>
                                <td>
                                    <strong>{{ product.item_name[:40] }}{% if product.item_name|length > 40 %}...{% endif %}</strong>
                                    <br>
                                    <small class="text-muted">ID: {{ product.item_id }}</small>
                                </td>
                                <td>
                                    <code>{{ product.item_sku if product.item_sku else '-' }}</code>
                                </td>
                                <td>
                                    {% set status_class = {
                                        'NORMAL': 'success',
                                        'BANNED': 'danger',
                                        'DELETED': 'secondary',
                                        'UNLIST': 'warning'
                                    } %}
                                    <span class="badge bg-{{ status_class.get(product.item_status, 'secondary') }}">
                                        {{ product.item_status }}
                                    </span>
                                </td>
                                <td>
                                    {% if product.category_list %}
                                        {% for category in product.category_list %}
                                            <small>{{ category.display_category_name }}</small>
                                            {% if not loop.last %} > {% endif %}
                                        {% endfor %}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                    {% if product.price_info %}
                                        <strong>{{ "Rp {:,.0f}".format(product.price_info.current_price) if product.price_info.current_price else '-' }}</strong>
                                        {% if product.price_info.original_price and product.price_info.original_price != product.price_info.current_price %}
                                            <br><small class="text-muted text-decoration-line-through">
                                                Rp {{ "{:,.0f}".format(product.price_info.original_price) }}
                                            </small>
                                        {% endif %}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                    {% if product.stock_info %}
                                        <span class="badge bg-info">{{ product.stock_info.normal_stock or 0 }}</span>
                                        {% if product.stock_info.reserved_stock %}
                                            <br><small class="text-muted">Reserved: {{ product.stock_info.reserved_stock }}</small>
                                        {% endif %}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge bg-success">{{ product.sales or 0 }}</span>
                                    {% if product.views %}
                                        <br><small class="text-muted">{{ product.views }} views</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <button class="btn btn-outline-primary btn-sm" 
                                            onclick="showProductDetail('{{ product.item_id }}')">
                                        <i class="fas fa-eye"></i> Detail
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Pagination -->
{% if total_pages > 1 %}
<div class="row pagination-container">
    <div class="col-12">
        <nav aria-label="Products pagination">
            <ul class="pagination justify-content-center">
                {% if page > 1 %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page - 1 }}">
                            <i class="fas fa-chevron-left"></i> Previous
                        </a>
                    </li>
                {% endif %}
                
                {% for p in range(1, total_pages + 1) %}
                    {% if p == page %}
                        <li class="page-item active">
                            <span class="page-link">{{ p }}</span>
                        </li>
                    {% elif p <= 3 or p >= total_pages - 2 or (p >= page - 1 and p <= page + 1) %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ p }}">{{ p }}</a>
                        </li>
                    {% elif p == 4 and page > 6 %}
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                    {% elif p == total_pages - 3 and page < total_pages - 5 %}
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                    {% endif %}
                {% endfor %}
                
                {% if page < total_pages %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page + 1 }}">
                            Next <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                {% endif %}
            </ul>
        </nav>
    </div>
</div>
{% endif %}

{% else %}
<!-- Empty State -->
<div class="row">
    <div class="col-12">
        <div class="text-center py-5">
            <i class="fas fa-box fa-5x text-muted mb-4"></i>
            <h3 class="text-muted">Tidak Ada Data Produk</h3>
            <p class="text-muted mb-4">Tidak ada produk ditemukan di toko ini.</p>
            <a href="{{ url_for('shop_detail', shop_id=shop.shop_id) }}" class="btn btn-primary">
                <i class="fas fa-arrow-left"></i> Kembali ke Detail Toko
            </a>
        </div>
    </div>
</div>
{% endif %}

<!-- Product Detail Modal -->
<div class="modal fade" id="productDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detail Produk</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="productDetailContent">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
function exportProducts() {
    if (confirmExport('products', '{{ shop.shop_name }}')) {
        window.location.href = `/export/{{ shop.shop_id }}/products`;
    }
}

function showProductDetail(itemId) {
    var modal = new bootstrap.Modal(document.getElementById('productDetailModal'));
    modal.show();
    
    // Find product data from current page
    var productData = null;
    {% for product in products %}
        if ({{ product.item_id }} == itemId) {
            productData = {{ product|tojson }};
        }
    {% endfor %}
    
    if (productData) {
        displayProductDetail(productData);
    } else {
        document.getElementById('productDetailContent').innerHTML = 
            '<div class="alert alert-danger">Product detail tidak ditemukan</div>';
    }
}

function displayProductDetail(product) {
    var content = `
        <div class="row">
            <div class="col-md-4">
                <h6>Images</h6>
    `;
    
    if (product.image && product.image.image_url_list && product.image.image_url_list.length > 0) {
        content += '<div class="row">';
        product.image.image_url_list.slice(0, 4).forEach((imageUrl, index) => {
            content += `
                <div class="col-6 mb-2">
                    <img src="${imageUrl}" class="img-fluid rounded" alt="Product Image ${index + 1}">
                </div>
            `;
        });
        content += '</div>';
        
        if (product.image.image_url_list.length > 4) {
            content += `<small class="text-muted">+${product.image.image_url_list.length - 4} gambar lainnya</small>`;
        }
    } else {
        content += '<div class="text-center text-muted"><i class="fas fa-image fa-3x"></i><br>No Images</div>';
    }
    
    content += `
            </div>
            <div class="col-md-8">
                <h6>Informasi Produk</h6>
                <table class="table table-sm">
                    <tr><td><strong>Item ID:</strong></td><td>${product.item_id}</td></tr>
                    <tr><td><strong>Item Name:</strong></td><td>${product.item_name}</td></tr>
                    <tr><td><strong>SKU:</strong></td><td>${product.item_sku || '-'}</td></tr>
                    <tr><td><strong>Status:</strong></td><td><span class="badge bg-primary">${product.item_status}</span></td></tr>
                    <tr><td><strong>Has Model:</strong></td><td>${product.has_model ? 'Yes' : 'No'}</td></tr>
                </table>
                
                <h6>Price & Stock</h6>
                <table class="table table-sm">
    `;
    
    if (product.price_info) {
        content += `
            <tr><td><strong>Current Price:</strong></td><td><strong>Rp ${(product.price_info.current_price || 0).toLocaleString()}</strong></td></tr>
            <tr><td><strong>Original Price:</strong></td><td>Rp ${(product.price_info.original_price || 0).toLocaleString()}</td></tr>
            <tr><td><strong>Currency:</strong></td><td>${product.price_info.currency || '-'}</td></tr>
        `;
    }
    
    if (product.stock_info) {
        content += `
            <tr><td><strong>Normal Stock:</strong></td><td>${product.stock_info.normal_stock || 0}</td></tr>
            <tr><td><strong>Reserved Stock:</strong></td><td>${product.stock_info.reserved_stock || 0}</td></tr>
        `;
    }
    
    content += `
                </table>
                
                <h6>Sales & Performance</h6>
                <table class="table table-sm">
                    <tr><td><strong>Sales:</strong></td><td>${product.sales || 0}</td></tr>
                    <tr><td><strong>Views:</strong></td><td>${product.views || 0}</td></tr>
                    <tr><td><strong>Likes:</strong></td><td>${product.likes || 0}</td></tr>
                </table>
            </div>
        </div>
    `;
    
    if (product.category_list && product.category_list.length > 0) {
        content += `
            <div class="row mt-3">
                <div class="col-12">
                    <h6>Categories</h6>
                    <div>
        `;
        
        product.category_list.forEach(category => {
            content += `<span class="badge bg-secondary me-1">${category.display_category_name}</span>`;
        });
        
        content += `
                    </div>
                </div>
            </div>
        `;
    }
    
    if (product.description) {
        content += `
            <div class="row mt-3">
                <div class="col-12">
                    <h6>Description</h6>
                    <div class="bg-light p-3 rounded">
                        ${product.description.replace(/\n/g, '<br>')}
                    </div>
                </div>
            </div>
        `;
    }
    
    if (product.dimension) {
        content += `
            <div class="row mt-3">
                <div class="col-12">
                    <h6>Dimensions & Weight</h6>
                    <table class="table table-sm">
                        <tr><td><strong>Package Length:</strong></td><td>${product.dimension.package_length || 0} cm</td></tr>
                        <tr><td><strong>Package Width:</strong></td><td>${product.dimension.package_width || 0} cm</td></tr>
                        <tr><td><strong>Package Height:</strong></td><td>${product.dimension.package_height || 0} cm</td></tr>
                        <tr><td><strong>Weight:</strong></td><td>${product.weight || 0} kg</td></tr>
                    </table>
                </div>
            </div>
        `;
    }
    
    if (product.brand) {
        content += `
            <div class="row mt-3">
                <div class="col-12">
                    <h6>Brand</h6>
                    <p><strong>${product.brand.display_brand_name || '-'}</strong></p>
                </div>
            </div>
        `;
    }
    
    content += `
        <div class="row mt-3">
            <div class="col-12">
                <h6>Timestamps</h6>
                <table class="table table-sm">
                    <tr><td><strong>Created:</strong></td><td>${formatTimestamp(product.create_time)}</td></tr>
                    <tr><td><strong>Updated:</strong></td><td>${formatTimestamp(product.update_time)}</td></tr>
                </table>
            </div>
        </div>
    `;
    
    document.getElementById('productDetailContent').innerHTML = content;
}

function formatTimestamp(timestamp) {
    if (!timestamp) return '-';
    return new Date(timestamp * 1000).toLocaleString('id-ID');
}
</script>
{% endblock %}