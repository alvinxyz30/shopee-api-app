{% extends "base.html" %}

{% block title %}{{ shop.shop_name }} - Shopee API Integration{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1>
                    <i class="fas fa-store"></i> {{ shop.shop_name }}
                </h1>
                <p class="text-muted mb-0">Shop ID: {{ shop.shop_id }}</p>
            </div>
            <div>
                <!-- Token Status Badge -->
                {% if token_status == 'valid' %}
                    <span class="badge bg-success fs-6">
                        <i class="fas fa-check-circle"></i> Token Valid
                    </span>
                {% elif token_status == 'expires_soon' %}
                    <span class="badge bg-warning fs-6">
                        <i class="fas fa-exclamation-triangle"></i> Token Akan Expired
                    </span>
                {% else %}
                    <span class="badge bg-danger fs-6">
                        <i class="fas fa-times-circle"></i> Token Expired
                    </span>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Shop Info Card -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-info-circle"></i> Informasi Toko
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Nama Toko:</strong> {{ shop.shop_name }}</p>
                        <p><strong>Shop ID:</strong> {{ shop.shop_id }}</p>
                        <p><strong>Account:</strong> {{ shop.shop_account }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Ditambahkan:</strong> {{ shop.created_at.strftime('%d/%m/%Y %H:%M') }}</p>
                        <p><strong>Update Terakhir:</strong> {{ shop.updated_at.strftime('%d/%m/%Y %H:%M') }}</p>
                        {% if shop.expires_at %}
                        <p><strong>Token Expired:</strong> {{ shop.expires_at.strftime('%d/%m/%Y %H:%M') }}</p>
                        {% endif %}
                    </div>
                </div>
                
                {% if token_status != 'valid' %}
                <div class="alert alert-warning mt-3">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Perhatian!</strong> 
                    {% if token_status == 'expires_soon' %}
                        Token akan expired dalam waktu dekat. Refresh token atau login ulang untuk memastikan akses API.
                    {% else %}
                        Token sudah expired. Silakan login ulang untuk melanjutkan menggunakan API.
                    {% endif %}
                </div>
                
                <div class="mt-3">
                    <a href="{{ url_for('auth_shop') }}" class="btn btn-warning">
                        <i class="fas fa-sign-in-alt"></i> Login Ulang
                    </a>
                    <button class="btn btn-outline-primary" onclick="refreshToken('{{ shop.shop_id }}')">
                        <i class="fas fa-sync"></i> Refresh Token
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% if token_status == 'valid' %}
<!-- Data Options -->
<div class="row">
    <div class="col-md-4 mb-3">
        <div class="card h-100">
            <div class="card-body text-center">
                <i class="fas fa-shopping-cart fa-3x text-primary mb-3"></i>
                <h5 class="card-title">Data Order</h5>
                <p class="card-text">Lihat dan export data pesanan, transaksi, dan detail pembeli.</p>
                <div class="mt-auto">
                    <a href="{{ url_for('view_orders', shop_id=shop.shop_id) }}" class="btn btn-primary">
                        <i class="fas fa-eye"></i> Lihat Data
                    </a>
                    <div class="mt-2">
                        <button class="btn btn-outline-success btn-sm export-btn" 
                                onclick="exportData('{{ shop.shop_id }}', 'orders', '{{ shop.shop_name }}')">
                            <i class="fas fa-file-excel"></i> Export Excel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4 mb-3">
        <div class="card h-100">
            <div class="card-body text-center">
                <i class="fas fa-box fa-3x text-success mb-3"></i>
                <h5 class="card-title">Data Produk</h5>
                <p class="card-text">Lihat dan export data produk, stok, harga, dan kategori.</p>
                <div class="mt-auto">
                    <a href="{{ url_for('view_products', shop_id=shop.shop_id) }}" class="btn btn-success">
                        <i class="fas fa-eye"></i> Lihat Data
                    </a>
                    <div class="mt-2">
                        <button class="btn btn-outline-success btn-sm export-btn" 
                                onclick="exportData('{{ shop.shop_id }}', 'products', '{{ shop.shop_name }}')">
                            <i class="fas fa-file-excel"></i> Export Excel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4 mb-3">
        <div class="card h-100">
            <div class="card-body text-center">
                <i class="fas fa-undo fa-3x text-warning mb-3"></i>
                <h5 class="card-title">Data Return</h5>
                <p class="card-text">Lihat dan export data return, refund, dan keluhan pelanggan.</p>
                <div class="mt-auto">
                    <a href="{{ url_for('view_returns', shop_id=shop.shop_id) }}" class="btn btn-warning">
                        <i class="fas fa-eye"></i> Lihat Data
                    </a>
                    <div class="mt-2">
                        <button class="btn btn-outline-success btn-sm export-btn" 
                                onclick="exportData('{{ shop.shop_id }}', 'returns', '{{ shop.shop_name }}')">
                            <i class="fas fa-file-excel"></i> Export Excel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Date Range Export -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-calendar-alt"></i> Export Data dengan Range Tanggal
                </h5>
            </div>
            <div class="card-body">
                <form id="dateRangeForm">
                    <div class="row">
                        <div class="col-md-3">
                            <label for="date_from" class="form-label">Tanggal Mulai</label>
                            <input type="date" class="form-control" id="date_from" name="date_from" required>
                        </div>
                        <div class="col-md-3">
                            <label for="date_to" class="form-label">Tanggal Akhir</label>
                            <input type="date" class="form-control" id="date_to" name="date_to" required>
                        </div>
                        <div class="col-md-3">
                            <label for="data_type" class="form-label">Tipe Data</label>
                            <select class="form-select" id="data_type" name="data_type" required>
                                <option value="">Pilih Tipe Data</option>
                                <option value="orders">Data Order</option>
                                <option value="returns">Data Return</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <button type="submit" class="btn btn-primary d-block w-100">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                    </div>
                </form>
                
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i>
                        Maksimal range tanggal: 1 tahun untuk orders, 2.5 tahun untuk returns.
                        Data produk tidak memerlukan range tanggal.
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

{% endif %}

<!-- Quick Actions -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-bolt"></i> Quick Actions
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-2">
                        <a href="{{ url_for('api_logs', shop_id=shop.shop_id) }}" class="btn btn-outline-info w-100">
                            <i class="fas fa-history"></i> Lihat Log API
                        </a>
                    </div>
                    <div class="col-md-3 mb-2">
                        <button class="btn btn-outline-warning w-100" onclick="refreshToken('{{ shop.shop_id }}')">
                            <i class="fas fa-sync"></i> Refresh Token
                        </button>
                    </div>
                    <div class="col-md-3 mb-2">
                        <a href="{{ url_for('add_shop') }}" class="btn btn-outline-primary w-100">
                            <i class="fas fa-plus"></i> Tambah Toko Lain
                        </a>
                    </div>
                    <div class="col-md-3 mb-2">
                        <button class="btn btn-outline-danger w-100" onclick="deleteShop('{{ shop.shop_id }}', '{{ shop.shop_name }}')">
                            <i class="fas fa-trash"></i> Hapus Toko
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Shop Form (Hidden) -->
<form id="deleteShopForm" method="POST" style="display: none;">
</form>

{% endblock %}

{% block scripts %}
<script>
// Set default date range (last 30 days)
document.addEventListener('DOMContentLoaded', function() {
    var today = new Date();
    var thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
    
    document.getElementById('date_to').value = today.toISOString().split('T')[0];
    document.getElementById('date_from').value = thirtyDaysAgo.toISOString().split('T')[0];
});

// Export data with date range
document.getElementById('dateRangeForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    var dateFrom = document.getElementById('date_from').value;
    var dateTo = document.getElementById('date_to').value;
    var dataType = document.getElementById('data_type').value;
    
    if (!dateFrom || !dateTo || !dataType) {
        alert('Semua field harus diisi!');
        return;
    }
    
    // Validate date range
    var fromDate = new Date(dateFrom);
    var toDate = new Date(dateTo);
    var diffDays = (toDate - fromDate) / (1000 * 60 * 60 * 24);
    
    if (diffDays < 0) {
        alert('Tanggal mulai tidak boleh lebih besar dari tanggal akhir!');
        return;
    }
    
    var maxDays = dataType === 'returns' ? 912 : 365; // 2.5 years for returns, 1 year for orders
    if (diffDays > maxDays) {
        alert(`Maksimal range tanggal untuk ${dataType} adalah ${maxDays} hari!`);
        return;
    }
    
    if (confirmExport(dataType, '{{ shop.shop_name }}')) {
        var url = `/export/{{ shop.shop_id }}/${dataType}?date_from=${dateFrom}&date_to=${dateTo}`;
        window.location.href = url;
    }
});

function exportData(shopId, dataType, shopName) {
    if (confirmExport(dataType, shopName)) {
        var url = `/export/${shopId}/${dataType}`;
        window.location.href = url;
    }
}

function refreshToken(shopId) {
    if (confirm('Refresh token untuk toko ini?')) {
        // Implementasi refresh token via AJAX
        fetch(`/api/refresh_token/${shopId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Token berhasil di-refresh!');
                location.reload();
            } else {
                alert('Gagal refresh token: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error: ' + error.message);
        });
    }
}

function deleteShop(shopId, shopName) {
    if (confirm(`Apakah Anda yakin ingin menghapus toko "${shopName}"?\n\nTindakan ini akan menghapus toko dan semua data terkait.`)) {
        var form = document.getElementById('deleteShopForm');
        form.action = `/delete_shop/${shopId}`;
        form.submit();
    }
}
</script>
{% endblock %}